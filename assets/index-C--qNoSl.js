(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const l of document.querySelectorAll('link[rel="modulepreload"]'))s(l);new MutationObserver(l=>{for(const t of l)if(t.type==="childList")for(const n of t.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&s(n)}).observe(document,{childList:!0,subtree:!0});function r(l){const t={};return l.integrity&&(t.integrity=l.integrity),l.referrerPolicy&&(t.referrerPolicy=l.referrerPolicy),l.crossOrigin==="use-credentials"?t.credentials="include":l.crossOrigin==="anonymous"?t.credentials="omit":t.credentials="same-origin",t}function s(l){if(l.ep)return;l.ep=!0;const t=r(l);fetch(l.href,t)}})();const v=document.getElementById("main"),w=v.getContext("2d"),ae=document.getElementById("hexSize"),xe=document.getElementById("hexSizeLabel"),J=document.getElementById("seriesCount"),we=document.getElementById("regen"),Me=document.getElementById("download"),H=document.getElementById("mockData"),ne=document.getElementById("toggleView"),ce=document.getElementById("smoothPercent"),Ee=document.getElementById("smoothPercentLabel");let R=!1;const W=document.getElementById("globalOrder"),oe=document.getElementById("resetOrder");let I=null,L=null,k=[],S=null,D=[],F=null;function Se(){if(F)return F;const e=document.createElement("div");return e.style.position="fixed",e.style.zIndex="9999",e.style.pointerEvents="none",e.style.background="rgba(0, 0, 0, 0.75)",e.style.color="#cfe8ff",e.style.padding="6px 8px",e.style.borderRadius="4px",e.style.font="12px Inter, Arial, sans-serif",e.style.whiteSpace="nowrap",e.style.boxShadow="0 2px 8px rgba(0,0,0,0.3)",e.style.backdropFilter="blur(2px)",e.style.display="none",document.body.appendChild(e),F=e,e}function Ae(e,o,r){const s=Se();s.innerHTML=r,s.style.display="block";const l=12;let t=e+l,n=o+l;const{innerWidth:a,innerHeight:i}=window,d=s.getBoundingClientRect();t+d.width+8>a&&(t=Math.max(8,a-d.width-8)),n+d.height+8>i&&(n=Math.max(8,i-d.height-8)),s.style.left=`${t}px`,s.style.top=`${n}px`}function q(){F&&(F.style.display="none")}function Ie(e,o){return Object.assign(document.createElement("canvas"),{width:e,height:o})}function Te(e){const o=["Rose","Tulip","Daffodil","Lily","Orchid","Sunflower","Daisy","Marigold","Peony","Iris","Lavender","Carnation","Chrysanthemum","Gardenia","Hydrangea"];return o[e%o.length]}function fe(e,o){const r=o??25+Math.floor(Math.random()*25),s=1,l=Array.from({length:r},(n,a)=>s+a),t=[];for(let n=0;n<e;n++){const a=Math.random()*.5+.2+n*.03,i=Math.random()*Math.PI*2,d=3+Math.random()*4,c=l.map((f,h)=>{const g=h/Math.max(1,r-1);return Math.max(0,a+.7*Math.abs(Math.sin(g*d+i))+.25*(Math.random()-.5))});t.push({name:Te(n),values:c})}return{values:l,series:t}}function Le(e){if(!e||!Array.isArray(e.values)||!Array.isArray(e.series)||e.series.length===0)throw new Error("Invalid MockData: missing values/series.");const o=e.values.length;for(const n of e.series)if(!Array.isArray(n.values)||n.values.length!==o)throw new Error("Invalid MockData: each series.values length must equal values length.");const r=e.series.length,s=e.series.map(n=>n.values.map(a=>Math.max(0,a))),l=Array.from({length:r},()=>new Array(o).fill(0));for(let n=0;n<o;n++){let a=0;for(let i=0;i<r;i++)a+=s[i][n];if(a<=0){const i=1/r;for(let d=0;d<r;d++)l[d][n]=i}else for(let i=0;i<r;i++)l[i][n]=s[i][n]/a}return{mock:{x:Array.from({length:o},(n,a)=>a),series:l},names:e.series.map(n=>n.name)}}function ke(e,o,r){const s=(1-Math.abs(2*r-1))*o,l=e/60,t=s*(1-Math.abs(l%2-1));let n=0,a=0,i=0;l>=0&&l<1?[n,a,i]=[s,t,0]:l<2?[n,a,i]=[t,s,0]:l<3?[n,a,i]=[0,s,t]:l<4?[n,a,i]=[0,t,s]:l<5?[n,a,i]=[t,0,s]:[n,a,i]=[s,0,t];const d=r-s/2,c=m=>Math.round((m+d)*255),f=c(n).toString(16).padStart(2,"0"),h=c(a).toString(16).padStart(2,"0"),g=c(i).toString(16).padStart(2,"0");return`#${f}${h}${g}`}function Ce(e){const o=["#2563eb","#7c3aed","#ec4899","#ef4444","#f59e0b","#10b981","#06b6d4","#374151"];if(e<=o.length)return o.slice(0,e);const r=[...o],s=137.508,l=0;for(let t=o.length;t<e;t++){const n=t-o.length,a=(l+n*s)%360,i=[.6,.66,.54],d=[.52,.58,.46,.4],c=i[n%i.length],f=d[n%d.length];r.push(ke(a,c,f))}return r}function Oe(e,o,r,s,l){e.clearRect(0,0,o,r);const t=s.x.length,n=20,a=s.x.map((c,f)=>f/(t-1)*(o-n*2)+n),i=s.series.length,d=Array.from({length:i},()=>Array(t).fill(0));for(let c=0;c<t;c++){let f=0;for(let h=0;h<i;h++)f+=s.series[h]?.[c]??0,d[h][c]=f}for(let c=i-1;c>=0;c--){e.beginPath();for(let f=0;f<t;f++){const h=a[f],g=r-(d[c][f]*(r-n*2)+n);f===0?e.moveTo(h,g):e.lineTo(h,g)}for(let f=t-1;f>=0;f--){const h=a[f],g=c>0?d[c-1][f]:0,m=r-(g*(r-n*2)+n);e.lineTo(h,m)}e.closePath(),e.fillStyle=l[c%l.length],e.fill()}de(e,o,r,n,L?.values)}function de(e,o,r,s,l){e.strokeStyle="rgba(255,255,255,0.10)",e.lineWidth=1,e.beginPath(),e.moveTo(s,s),e.lineTo(s,r-s),e.lineTo(o-s,r-s),e.stroke(),e.save(),e.font="8px Inter, Arial",e.fillStyle="#cfe8ff",e.textBaseline="top";const t=5;for(let a=0;a<=t;a++){const i=a/t,d=s+i*(o-s*2);e.strokeStyle="rgba(255,255,255,0.12)",e.beginPath(),e.moveTo(d,r-s),e.lineTo(d,r-s+5),e.stroke();let c="";if(l&&l.length>0){const h=Math.round(i*(l.length-1));c=String(l[h])}else c=(i*100).toFixed(0)+"%";const f=e.measureText(c).width;e.fillText(c,d-f/2,r-s+7)}e.textBaseline="middle",e.textAlign="right";const n=[0,.25,.5,.75,1];for(const a of n){const i=r-(a*(r-s*2)+s);e.strokeStyle=a===0||a===1?"rgba(255,255,255,0.12)":"rgba(255,255,255,0.06)",e.beginPath(),e.moveTo(s-4,i),e.lineTo(s,i),e.stroke();const d=`${Math.round(a*100)}%`;e.fillStyle="#cfe8ff",e.fillText(d,s,i)}e.restore()}const Pe=.5;function se(e,o,r){const s=Math.max(0,r-Pe),l=[];for(let t=0;t<6;t++){const n=(60*t-30)*Math.PI/180;l.push([e+s*Math.cos(n),o+s*Math.sin(n)])}return l}function Be(e,o,r){let s=!1;for(let l=0,t=r.length-1;l<r.length;t=l++){const[n,a]=r[l],[i,d]=r[t];a>o!=d>o&&e<(i-n)*(o-a)/(d-a)+n&&(s=!s)}return s}function Ne(e,o){const r=e.length;if(o<=1)return e.slice();const s=Math.floor(o/2),l=new Array(r+1).fill(0);for(let n=0;n<r;n++)l[n+1]=l[n]+(e[n]??0);const t=new Array(r);for(let n=0;n<r;n++){const a=Math.max(0,n-s),i=Math.min(r-1,n+s),d=l[i+1]-l[a];t[n]=d/(i-a+1)}return t}function re(e,o,r){const s=e.series.length,l=e.x.length,t=Array.from({length:o},()=>new Array(s).fill(0)),n=l/o,a=r?n*.5:0;for(let i=0;i<o;i++){const d=i*n+a,c=(i+1)*n+a,f=Math.max(0,Math.floor(d)),h=Math.min(l,Math.ceil(c));for(let m=f;m<h;m++)for(let u=0;u<s;u++){const y=Math.max(0,e.series[u][m]??0);t[i][u]+=y}let g=0;for(let m=0;m<s;m++)g+=t[i][m];if(g<=0){const m=1/s;for(let u=0;u<s;u++)t[i][u]=m}else for(let m=0;m<s;m++)t[i][m]/=g}return t}function Re(e,o,r){const s=new Array(r).fill(0),l=t=>{for(let n=0;n<t.length;n++){const a=t[n]||[];for(let i=0;i<r;i++)s[i]+=a[i]||0}};return l(e),l(o),Array.from({length:r},(t,n)=>n).sort((t,n)=>s[n]-s[t])}function le(e,o,r){const s=e.length,l=r.length,t=new Array(s);for(let n=0;n<s;n++){const a=e[n]??[],i=new Array(l).fill(0).map((u,y)=>Math.max(0,a[y]??0));let d=i.reduce((u,y)=>u+y,0);const c=d>0?i.map(u=>u/d):new Array(l).fill(1/Math.max(1,l)),f=r.map(u=>c[u]),h=new Array(l);let g=0;for(let u=0;u<l;u++)g+=f[u],h[u]=g;h[l-1]=1;const m=new Array(o);for(let u=0;u<o;u++){const M=1-(u+.5)/Math.max(1,o);let b=0;for(;b<l-1&&M>h[b];)b++;m[u]=r[b]}t[n]=m}return t}function ie(e,o,r,s,l){e.font="13px Inter, Arial";for(let t=0;t<s.length;t++){e.fillStyle=s[t],e.fillRect(o,r+t*22,16,12),e.fillStyle="#cfe8ff";const n=l[t]||`Series ${t+1}`;e.fillText(n,o+22,r+t*22+10)}}let B=[],_=!1;function C(){_||(_=!0,window.requestAnimationFrame(()=>{_=!1,Fe()}))}function De(e,o,r,s,l,t,n,a){const i=Array.from({length:o},()=>[]);for(let d=0;d<o;d++){const c=l+d*t,f=d%2===0,h=f?r:r+s/2,g=Math.floor(d/2),m=f?n:a;for(let u=0;u<e;u++){const y=h+u*s;if(y<20+s*.25||y>v.clientWidth-20-s*.25)continue;const M=m[u]?.[g]??0;i[d].push({x:y,y:c,series:M,col:u})}}return i}let ue=null;function Fe(){if(!S)return;const e=Math.max(1,window.devicePixelRatio||1),o=v.clientWidth,r=v.clientHeight,s=parseInt(ae.value,10);xe.textContent=String(s);const l=S.series.length;(!B||B.length!==l)&&(B=Ce(l));const t=B;if(w.clearRect(0,0,o,r),!R){const p=Ie(Math.round(o*e),Math.round(r*e)),E=p.getContext("2d");E.setTransform(e,0,0,e,0,0),E.fillStyle="#071022",E.fillRect(0,0,o,r),Oe(E,o,r,S,t),w.drawImage(p,0,0,o,r),ie(w,24,24,t,k),D=[];return}const n={left:20,top:20,right:o-20,bottom:r-20};ue=n,D=[];const a=Math.sqrt(3)*s,i=1.5*s,d=Math.max(1,n.right-n.left),c=Math.max(1,Math.floor(d/a)),f=parseInt(ce.value,10);Ee.textContent=`${f}`;let h;if(f>2){const p=f/100,E=Math.max(1,Math.round(S.x.length*p));h={x:S.x,series:S.series.map(T=>Ne(T,E))}}else h=S;const g=re(h,c,!1),m=re(h,c,!0),u=n.top+s,y=n.bottom-s,M=Math.max(1,Math.floor((y-u)/i)+1),b=Math.ceil(M/2),ge=Math.floor(M/2),K=Re(g,m,l),V=I&&I.length===K.length?I:K;me(V);const pe=le(g,b,V),ye=le(m,ge,V),ve=n.left+a/2,$=De(c,M,ve,a,u,i,pe,ye);for(let p=0;p<$.length;p++){const T=p%2===0?g:m;for(const x of $[p]){const O=x.col,be=T[O]||new Array(l).fill(0),Q=new Array(l);let Z=0;for(let A=0;A<l;A++){const P=Math.max(0,be[A]||0),te=Math.round(P*1e3);Q[A]=te,Z+=te}const ee=se(x.x,x.y,s);let z=1/0,X=1/0,j=-1/0,Y=-1/0;for(const[A,P]of ee)A<z&&(z=A),P<X&&(X=P),A>j&&(j=A),P>Y&&(Y=P);D.push({poly:ee,cx:x.x,cy:x.y,series:x.series,counts:Q,samples:Z,bbox:{minX:z,minY:X,maxX:j,maxY:Y}})}}const N=new Array(l).fill(null).map(()=>new Path2D);for(let p=0;p<$.length;p++)for(const E of $[p]){const T=E.series,x=se(E.x,E.y,s);N[T].moveTo(x[0][0],x[0][1]);for(let O=1;O<x.length;O++)N[T].lineTo(x[O][0],x[O][1]);N[T].closePath()}for(let p=0;p<l;p++)w.fillStyle=t[p],w.fill(N[p]);w.globalCompositeOperation="multiply",w.fillStyle="rgba(0,0,0,0.06)";for(let p=0;p<l;p++)w.fill(N[p]);w.globalCompositeOperation="source-over",ie(w,24,24,t,k),de(w,o,r,20,L?.values)}function $e(e){try{const o=JSON.parse(e);if(!o||!Array.isArray(o.values)||!Array.isArray(o.series))throw new Error("Invalid data: must contain values and series arrays.");return o}catch(o){try{return He(e)}catch(r){throw r||o}}}function He(e){const r=e.replace(/\r\n?/g,`
`).trim().split(`
`).filter(c=>c.trim().length>0);if(r.length<2)throw new Error("TSV must include a header and at least one data row.");const s=c=>c.split("	").map(f=>f.trim()),l=s(r[0]);if(l.length<2)throw new Error("Header must include an index column and at least one series column.");const t=l.slice(1).map(c=>{const f=c.indexOf(":");return f>=0?c.slice(f+1).trim():c}),n=[],a=t.map(()=>[]);for(let c=1;c<r.length;c++){const f=s(r[c]),h=f[0]??"",g=Number.parseFloat(h);n.push(Number.isFinite(g)?g:c);for(let m=0;m<t.length;m++){const u=f[m+1]??"",y=Number.parseFloat(u);a[m].push(Number.isFinite(y)?y:0)}}const i=t.map((c,f)=>({name:c,values:a[f]})),d=n.length;for(const c of i)if(c.values.length!==d)throw new Error("Irregular row widths detected while parsing TSV.");return{values:n,series:i}}function U(e){L=e,k=e.series.map(r=>r.name),J.value=String(e.series.length);const o=Le(e);S=o.mock,k=o.names,C()}function Ve(){const e=fe(parseInt(J.value,10)||4,120+Math.floor(Math.random()*60));H.value=JSON.stringify(e,null,2),U(e)}function he(){const e=Math.max(1,window.devicePixelRatio||1),o=v.clientWidth,r=v.clientHeight;v.width=Math.round(o*e),v.height=Math.round(r*e),v.style.width=o+"px",v.style.height=r+"px",w.setTransform(e,0,0,e,0,0)}function ze(){he(),Ve()}ae.addEventListener("input",()=>C());ce.addEventListener("input",()=>C());we.addEventListener("click",()=>{const e=Math.max(1,parseInt(J.value,10)||1),o=fe(e);H.value=JSON.stringify(o,null,2),U(o)});Me.addEventListener("click",()=>{const e=document.createElement("a");e.download="hex-stacked-area.png";const o=document.createElement("canvas");o.width=v.width,o.height=v.height,o.getContext("2d").drawImage(v,0,0),e.href=o.toDataURL("image/png"),e.click()});let G;H.addEventListener("input",()=>{G&&window.clearTimeout(G),G=window.setTimeout(()=>{try{const e=$e(H.value);U(e)}catch(e){console.warn("Invalid mock data JSON:",e)}},250)});v.addEventListener("mousemove",e=>{if(!S||!R){q();return}const o=v.getBoundingClientRect(),r=e.clientX-o.left,s=e.clientY-o.top;let l=null;for(let y=0;y<D.length;y++){const M=D[y],b=M.bbox;if(!(b&&(r<b.minX||r>b.maxX||s<b.minY||s>b.maxY))&&Be(r,s,M.poly)){l=M;break}}if(!l){q();return}const t=ue??{left:20,right:o.width-20,bottom:o.height-20},n=Math.max(1,t.right-t.left),a=Math.min(1,Math.max(0,(r-t.left)/n)),i=S.x.length,d=Math.max(0,Math.min(i-1,Math.round(a*(i-1))));let c="";if(L?.values?.length){const y=Math.max(0,Math.min(L.values.length-1,Math.round(a*(L.values.length-1))));c=String(L.values[y])}else c=`${Math.round(a*100)}%`;const f=l.series,h=S.series[f]?.[d]??0,g=l.samples>0?l.counts[f]/l.samples:0,u=`
        <div><b>${k[f]||`Series ${f+1}`}</b></div>
        <div>Value: ${c}</div>
        <div>Share: ${(h*100).toFixed(1)}%</div>
        <div>Hex majority: ${(g*100).toFixed(0)}%</div>
    `.trim();Ae(e.clientX,e.clientY,u)});v.addEventListener("mouseleave",()=>q());ne.addEventListener("click",()=>{R=!R,ne.textContent=R?"Show Line":"Show Hex",C()});window.addEventListener("resize",()=>{he(),C()});function Xe(e,o,r){if(o===r)return;const s=e.splice(o,1)[0];e.splice(r,0,s)}function me(e){if(W){Math.max(e.length,k.length,B.length),W.innerHTML="";for(let o=0;o<e.length;o++){const r=e[o],s=k[r]??`Series ${r+1}`,l=B[r]??"#888",t=document.createElement("div");t.className="order-item",t.draggable=!0,t.dataset.pos=String(o),t.style.display="flex",t.style.alignItems="center",t.style.gap="8px",t.style.padding="6px",t.style.borderRadius="6px",t.style.cursor="grab",t.style.background="rgba(255,255,255,0.02)",t.style.border="1px solid rgba(255,255,255,0.03)";const n=document.createElement("div");n.style.width="18px",n.style.height="12px",n.style.background=l,n.style.borderRadius="3px",n.style.flex="0 0 auto";const a=document.createElement("div");a.style.fontSize="12px",a.style.color="#cfe8ff",a.textContent=s,t.appendChild(n),t.appendChild(a),t.addEventListener("dragstart",i=>{i.dataTransfer.setData("text/plain",String(o)),t.style.opacity="0.5"}),t.addEventListener("dragend",()=>{t.style.opacity="1"}),t.addEventListener("dragover",i=>{i.preventDefault(),t.style.boxShadow="inset 0 0 0 2px rgba(255,255,255,0.04)"}),t.addEventListener("dragleave",()=>{t.style.boxShadow=""}),t.addEventListener("drop",i=>{i.preventDefault(),t.style.boxShadow="";const d=i.dataTransfer.getData("text/plain"),c=Number(d),f=Number(t.dataset.pos);if(!Number.isFinite(c)||!Number.isFinite(f))return;const h=I?I.slice():e.slice();Xe(h,c,f),I=h,me(I),C()}),W.prepend(t)}}}oe&&oe.addEventListener("click",()=>{I=null,C()});ze();
